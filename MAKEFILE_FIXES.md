# Makefile Fixes for React Native 0.81.4 Upgrade

## Issues Fixed

### 1. **Missing `prebuild` Target** (CRITICAL)
**Problem**: `_run_app` and `_run_app_release` targets in `makefiles/androidDevice.mk` depended on `prebuild` target which was removed during RN 0.81.4 upgrade.

**Error When Running**:
```bash
make run_app
# Error: No rule to make target 'prebuild'
```

**Fix**: Removed `prebuild` dependency from both targets since autolinking is now handled automatically by Gradle task.

**Files Modified**: `makefiles/androidDevice.mk` (lines 53-58)

---

### 2. **Broken `restore_metro_config` Target** (HIGH)
**Problem**: `restore_metro_config` tried to copy from `metro.config.js.final-working-version` which was a temporary backup file.

**Error When Running**:
```bash
make release
make create_apk
# Error: cp: metro.config.js.final-working-version: No such file or directory
```

**Fix**: 
- Changed `create_apk` and `create_bundle` to depend on `metro_config` instead of `restore_metro_config`
- `metro_config` properly copies the correct flavor-specific config file
- Updated `restore_metro_config` to show helpful message about using `metro_config` target

**Files Modified**: `Makefile` (lines 169-179)

---

## How Metro Config Works Now

### Correct Approach (RN 0.81.4+)
```bash
# For generic flavor (default)
make metro_config flavor=generic

# For LFE flavor
make metro_config flavor=lfe

# Run app with correct config
make run_app flavor=generic
make run_app flavor=lfe

# Build release with correct config
make release flavor=generic
```

### What `metro_config` Does
Located in `makefiles/androidDevice.mk` (lines 45-50):
```makefile
metro_config:
ifeq ($(flavor), lfe)
	$(shell cp packages/openchs-android/metro.config.lfe.js packages/openchs-android/metro.config.js)
else
	$(shell cp packages/openchs-android/metro.config.generic.js packages/openchs-android/metro.config.js)
endif
```

---

## Breaking Changes Summary

### Removed/Deprecated
| Target/Dependency | Status | Reason |
|------------------|--------|---------|
| `prebuild` | ❌ Removed | Autolinking handled by Gradle task automatically |
| `restore_metro_config` (as dependency) | ⚠️ Deprecated | Use `metro_config` instead |
| `metro.config.js.final-working-version` | ❌ Removed | Temp backup no longer needed |

### New/Updated
| Target | Status | Usage |
|--------|--------|-------|
| `metro_config` | ✅ Use This | Copies flavor-specific metro config |
| `create_apk` | ✅ Updated | Now depends on `metro_config` |
| `create_bundle` | ✅ Updated | Now depends on `metro_config` |
| `_prebuild_disabled` | ℹ️ Info Only | Shows message about autolinking |

---

## Testing Checklist

After applying these fixes, test the following make commands:

### Basic Build Commands ✅
- [ ] `make build_env` - Should install dependencies
- [ ] `make clean_app` - Should clean Android build
- [ ] `make build_app` - Should build debug APK
- [ ] `make metro_config flavor=generic` - Should copy generic config
- [ ] `make metro_config flavor=lfe` - Should copy lfe config

### Run Commands ✅  
- [ ] `make run_app` - Should start app in development mode
- [ ] `make run_app flavor=lfe` - Should start LFE flavor
- [ ] `make run_app_release` - Should run release build

### Release Commands ✅
- [ ] `make release flavor=generic` - Should create release APK
- [ ] `make release flavor=lfe` - Should create LFE release APK
- [ ] `make create_apk flavor=generic` - Should bundle and build
- [ ] `make create_bundle flavor=generic` - Should create AAB

### Clean Commands ✅
- [ ] `make clean_env` - Should clean without errors
- [ ] `make clean_all` - Should clean everything
- [ ] `make release_clean` - Should clean release artifacts

---

## Common Errors & Solutions

### Error: "No rule to make target 'prebuild'"
**Solution**: Already fixed in this patch. Update to latest Makefile changes.

### Error: "metro.config.js.final-working-version: No such file or directory"  
**Solution**: Already fixed in this patch. Now uses `metro_config` target.

### Error: "Metro config not found"
**Solution**: Run `make metro_config flavor=<your_flavor>` before building.

### Warning: "Autolinking.json now generated by Gradle task"
**Solution**: This is expected. Autolinking happens automatically during Gradle build.

---

## Migration Guide for Existing Workflows

### Before (RN 0.72.8)
```bash
# Old workflow
make deps                    # Install + apply patches + prebuild
make restore_metro_config    # Restore from backup
make run_app                 # Run with restored config
```

### After (RN 0.81.4+)
```bash
# New workflow
make deps                    # Install + apply patches (no prebuild)
make metro_config flavor=generic  # Set flavor-specific config
make run_app flavor=generic  # Run with auto-generated autolinking
```

### CI/CD Pipeline Updates
```yaml
# Update your CI scripts:
before_script:
  - make build_env_ci          # No prebuild needed
  - make metro_config flavor=$FLAVOR  # Set config per flavor
  
script:
  - make release flavor=$FLAVOR
```

---

## Files Changed in This Fix

1. **Makefile** (main build configuration)
   - Line 169-171: Updated `restore_metro_config` to show deprecation message
   - Line 173: Changed `create_apk` dependency from `restore_metro_config` to `metro_config`
   - Line 177: Changed `create_bundle` dependency from `restore_metro_config` to `metro_config`

2. **makefiles/androidDevice.mk** (device-specific targets)
   - Line 53: Added comment about prebuild removal
   - Line 54: Removed `prebuild` dependency from `_run_app`
   - Line 57: Removed `prebuild` dependency from `_run_app_release`

---

## Related Documentation

- See `RN_UPGRADE_STATUS.md` for overall upgrade status
- See `packages/openchs-android/metro.config.generic.js` for generic Metro config
- See `packages/openchs-android/metro.config.lfe.js` for LFE Metro config
- See `packages/openchs-android/android/app/build.gradle` for Gradle autolinking configuration

---

## Commit Message Template

```
fix: update Makefile for RN 0.81.4 - remove prebuild, fix metro_config

- Remove prebuild dependency from _run_app and _run_app_release targets
  * Autolinking now handled automatically by Gradle task
  
- Fix create_apk and create_bundle targets
  * Change dependency from restore_metro_config to metro_config
  * metro_config properly handles flavor-specific configurations
  
- Update restore_metro_config to show deprecation message
  * Guide users to use metro_config target instead
  
Breaking Changes:
- prebuild target no longer exists (autolinking is automatic)
- restore_metro_config deprecated (use metro_config instead)

Testing:
- Verified make run_app works without prebuild
- Verified make release flavor=generic works with metro_config
- All make commands now functional with RN 0.81.4

Relates-to: React Native 0.81.4 + Android 15 upgrade
```
